<!DOCTYPE html>
<html>

<head>

    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta charset="UTF-8">
    <title>Accessibility and Safety in Manhattan Subway Stations</title>
    <script>
        L_NO_TOUCH = false;
        L_DISABLE_3D = false;
    </script>
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
    <style>
        #header {
            background-color: #4CAF50;
            color: white;
            text-align: center;
            padding: 10px 20px;
            font-size: 24px;
        }

        #infoPanel {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            width: 300px;
            z-index: 1000;
        }

        #infoPanel input[type="text"],
        #infoPanel button {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
        }

        #infoPanel button {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #infoPanel button:hover {
            background-color: #45a049;
        }

        #results {
            margin-bottom: 10px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css" />
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css" />
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css" />

    <meta name="viewport" content="width=device-width,
                initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <style>
        #map {
            position: relative;
            width: 100.0%;
            height: 100.0%;
            left: 0.0%;
            top: 0.0%;
        }

        .leaflet-container {
            font-size: 1rem;
        }
    </style>

</head>

<body>
    <div id="header">Accessibility and Safety in Manhattan Subway Stations</div>

    <div class="folium-map" id="map"></div>

    <div id="infoPanel">
        <label for="start">Start:</label>
        <input type="text" id="start" placeholder="Enter start station"><br>
        <label for="end">End:</label>
        <input type="text" id="end" placeholder="Enter end station"><br>
        <button onclick="fetchStationData()">Go</button>
        <div id="results"></div>
    </div>
    <script>
        function fetchStationData() {
            var start = document.getElementById('start').value;
            var end = document.getElementById('end').value;
            fetch('/get-station-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ start: start, end: end })
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('results').innerHTML = `
                    <p><strong>Start Station Safety:</strong> ${data.start.safety}</p>
                    <p><strong>Start Station Accessibility:</strong> ${data.start.accessibility}</p>
                    <p><strong>End Station Safety:</strong> ${data.end.safety}</p>
                    <p><strong>End Station Accessibility:</strong> ${data.end.accessibility}</p>
                `;
                })
                .catch(error => console.error('Error:', error));
        }
    </script>


</body>
<script>


    var map = L.map(
        "map",
        {
            center: [40.7831, -73.9712],
            crs: L.CRS.EPSG3857,
            zoom: 13,
            zoomControl: true,
            preferCanvas: false,
        }
    );


    var tile_layer = L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
        { "attribution": "CartoDB", "detectRetina": false, "maxNativeZoom": 18, "maxZoom": 18, "minZoom": 0, "noWrap": false, "opacity": 1, "subdomains": "abc", "tms": false }
    ).addTo(map);



    function geo_json_d158c364196863fa3e22b023c37faa47_onEachFeature(feature, layer) {
        layer.on({
        });
    };
    var geo_json_d158c364196863fa3e22b023c37faa47 = L.geoJson(null, {
        onEachFeature: geo_json_d158c364196863fa3e22b023c37faa47_onEachFeature,

    });

    function geo_json_d158c364196863fa3e22b023c37faa47_add(data) {
        geo_json_d158c364196863fa3e22b023c37faa47
            .addData(data)
            .addTo(map);
    }
    fetch('/static/subway_lines.json')
        .then(response => response.json())
        .then(data => {
            geo_json_d158c364196863fa3e22b023c37faa47_add(data);
        })
        .catch(error => console.error('Error loading the GeoJSON file:', error));

    var markers = {};

    function updateMarkers() {
        fetch('/live-station-data')
            .then(response => response.json())
            .then(data => {
                data.forEach(station => {
                    var markerId = 'marker_' + station.station;

                    var color;
                    if (station.overall <= 33) {
                        color = "green";
                    } else if (station.overall <= 66) {
                        color = "orange";
                    } else {
                        color = "red";
                    }
                    icon = L.AwesomeMarkers.icon({
                        "extraClasses": "fa-rotate-0",
                        "icon": "train",
                        "iconColor": "white",
                        "markerColor": color,
                        "prefix": "fa"
                    });

                    var newMarker = L.marker(
                        [station.latitude, station.longitude],
                        {}
                    ).addTo(map);

                    newMarker.setIcon(icon);

                    var popup = L.popup({ "maxWidth": 450 });
                    popup.setContent(createPopupContent(station));
                    newMarker.bindPopup(popup);

                    markers[markerId] = newMarker;

                });
            })
            .catch(error => document.write('Error fetching the live data:', error));
    }

    function createPopupContent(station) {
        const elevatorAvailability = station.elevators - station.elevators_out;
        const escalatorAvailability = station.escalators - station.escalators_out;
        var crowd = station.ridership_pred;
        if (crowd < 0) {
            crowd = 0
        }

        var htmlContent = `<div>
        <h4>${station.station}</h4>
        <h5>Overall Metric: ${station.overall}</h5>
        <p><strong>Safety:</strong></p>
        <ul>
            <li><strong>Metric:</strong> ${station.safety_prior}</li>
            <li><strong>Weekly Prediction:</strong> ${station.safety_pred}</li>
        </ul>
        <p><strong>Accessibility:</strong></p>
        <ul>
            <li><strong>Elevators:</strong> ${Math.abs(elevatorAvailability)}/${station.elevators} available</li>
            <li><strong>Escalators:</strong> ${Math.abs(escalatorAvailability)}/${station.escalators} available</li>
        </ul>
        <p><strong>Crowd Prediction:</strong> ${station.ridership_pred}</p> 
    </div>`;
        return htmlContent;
    }

    setInterval(updateMarkers, 30000);
    updateMarkers();




</script>

</html>